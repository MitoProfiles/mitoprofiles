---
title: "MitoSignatures"
author: "Isabel Duarte"
date: "2023-05-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warnings=FALSE, cache = TRUE)

library(here)
library(tidyverse)
library(edgeR)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(gprofiler2)

```

## Load Differential Expression analyses results 

```{r load_data, eval=FALSE, warning=FALSE}

# Load data
gtex_de <- readRDS(here("data/analysis/gtex_de.RDS"))
tcga_de <- readRDS(here("data/analysis/tcga_de.RDS"))
combined_de <- readRDS(here("data/analysis/combined_de_with_interaction.RDS"))


```

## Functional enrichment analysis | GTEx

```{r gtex_func_enrich, eval=TRUE, warning=FALSE}

#  Create a list to hold the functional enrichment objects
gtex_fun <- list()

# Get Entrez Gene identifiers (required by edgeR functions)
rownames(gtex_de$lrt) %>%
  gsub('\\.\\d+', '', .) -> gtex_fun$ensembl_ids

# Convert Ensembl IDs to Entrez Gene IDs
columns(org.Hs.eg.db)

gtex_fun$entrez_ids <- mapIds(org.Hs.eg.db, 
                              keys = gtex_fun$ensembl_ids, 
                              column = "ENTREZID", 
                              keytype = "ENSEMBL", 
                              multiVals = "first")

# GO analysis
gtex_fun$go <- edgeR::goana.DGELRT(gtex_de$lrt, 
                                   geneid = gtex_fun$entrez_ids,
                                   species = "Hs")
gtex_fun$top_go <- topGO(gtex_fun$go, sort="up", p.value = 0.05)


# KEGG analysis
gtex_fun$kegg <- edgeR::kegga.DGELRT(gtex_de$lrt, 
                                     geneid = gtex_fun$entrez_ids,
                                     species = "Hs")
gtex_fun$top_kegg <- topKEGG(gtex_fun$kegg, sort="up", p.value = 0.05)

# Print a sentence confirming that this chunk finished computing
cat("Finished the GTEx functional enrichment analysis.")

```

## Functional enrichment analysis | TCGA

```{r tcga_func_enrich, eval=TRUE, warning=FALSE}

#  Create a list to hold the functional enrichment objects
tcga_fun <- list()

# Get Entrez Gene identifiers (required by edgeR functions)
rownames(tcga_de$lrt) %>%
  gsub('\\.\\d+', '', .) -> tcga_fun$ensembl_ids

# Convert Ensembl IDs to Entrez Gene IDs
tcga_fun$entrez_ids <- mapIds(org.Hs.eg.db, 
                              keys = tcga_fun$ensembl_ids, 
                              column = "ENTREZID", 
                              keytype = "ENSEMBL",
                              multiVals = "first")

# GO analysis
tcga_fun$go <- edgeR::goana.DGELRT(tcga_de$lrt, 
                                   geneid = tcga_fun$entrez_ids,
                                   species = "Hs")
tcga_fun$top_go <- topGO(tcga_fun$go, sort="up", p.value = 0.05)


# KEGG analysis
tcga_fun$kegg <- edgeR::kegga.DGELRT(tcga_de$lrt, 
                                     geneid = tcga_fun$entrez_ids,
                                     species = "Hs")
tcga_fun$top_kegg <- topKEGG(tcga_fun$kegg, sort="up", p.value = 0.05)

# Print a sentence confirming that this chunk finished computing
cat("Finished the TCGA functional enrichment analysis.")

```

## Functional enrichment analysis | Combined GTEx TCGA

```{r combined_func_enrich, eval=TRUE, warning=FALSE}

#  Create a list to hold the functional enrichment objects
combined_fun <- list()

# Get Entrez Gene identifiers (required by edgeR functions)
rownames(combined_de$lrt) %>%
  gsub('\\.\\d+', '', .) -> combined_fun$ensembl_ids

# Convert Ensembl IDs to Entrez Gene IDs
combined_fun$entrez_ids <- mapIds(org.Hs.eg.db, 
                              keys = combined_fun$ensembl_ids, 
                              column = "ENTREZID", 
                              keytype = "ENSEMBL",
                              multiVals = "first")

# GO analysis
combined_fun$go <- edgeR::goana.DGELRT(combined_de$lrt, 
                                   geneid = combined_fun$entrez_ids,
                                   species = "Hs")
combined_fun$top_go <- topGO(combined_fun$go, sort="up", p.value = 0.05)


# KEGG analysis
combined_fun$kegg <- edgeR::kegga.DGELRT(combined_de$lrt, 
                                     geneid = combined_fun$entrez_ids,
                                     species = "Hs")
combined_fun$top_kegg <- topKEGG(combined_fun$kegg, sort="up", p.value = 0.05)

# Print a sentence confirming that this chunk finished computing
cat("Finished the Combined GTEx TCGA functional enrichment analysis.")

```


## Functional enrichment | Using gprofiler2

```{r funct_enrich_gprofiler, eval=TRUE, warning=FALSE}
#
##
### GTEx | Perform functional enrichment analysis
##
#
gtex_fun$gprofiler <- gprofiler2::gost(
  query = gsub('\\.\\d+', '', rownames(gtex_de$topGenes$table)[1:500]),
  organism = "hsapiens",
  ordered_query = FALSE,
  user_threshold = 0.05,
  correction_method = "fdr",
  significant = TRUE
)

# Plot the results
gprofiler2::gostplot(gtex_fun$gprofiler)

# Print a sentence confirming that this chunk finished computing
cat("Finished the gprofiler GTEx functional enrichment analysis.")

#
##
### TCGA | Perform functional enrichment analysis
##
#
tcga_fun$gprofiler <- gprofiler2::gost(
  query = gsub('\\.\\d+', '', rownames(tcga_de$topGenes$table)[1:500]),
  organism = "hsapiens",
  ordered_query = FALSE,
  user_threshold = 0.05,
  correction_method = "fdr",
  significant = TRUE
)

# Plot the results
gprofiler2::gostplot(tcga_fun$gprofiler)

# Print a sentence confirming that this chunk finished computing
cat("Finished the gprofiler TCGA functional enrichment analysis.")

#
##
### Combined GTEx TCGA | Perform functional enrichment analysis
##
#
combined_fun$gprofiler <- gprofiler2::gost(
  query = gsub('\\.\\d+', '', rownames(combined_de$topGenes$table)[1:500]),
  organism = "hsapiens",
  ordered_query = FALSE,
  user_threshold = 0.05,
  correction_method = "fdr",
  significant = TRUE
)

# Plot the results
gprofiler2::gostplot(combined_fun$gprofiler)


# Print a sentence confirming that this chunk finished computing
cat("Finished the gprofiler Combined functional enrichment analysis.")

```

## Save the functional enrichment results

```{r save_fun_results, eval=TRUE, warning=FALSE}

# Save the gtex functional analysis results
saveRDS(gtex_fun, file = here("data/analysis/gtex_fun.RDS"))

# Save the tcga functional analysis results
saveRDS(tcga_fun, file = here("data/analysis/tcga_fun.RDS"))

# Save the gtex functional analysis results
saveRDS(combined_fun, file = here("data/analysis/combined_fun.RDS"))

# Print a sentence confirming that this chunk finished computing
cat("Finished saving to file the functional enrichment analysis results.")

```





